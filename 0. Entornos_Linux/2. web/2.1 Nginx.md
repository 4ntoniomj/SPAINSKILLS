# Instalación

```bash
apt update && apt install nginx -y
```

---
# Control NGINX

```bash
nginx -s <signal>
# quit -> Apagar
# reload -> Recarga configuración
# reopen -> Reabrir archivos de registro
# stop -> Apagar inmediatamente
```

----
# Configuración

Configuración de nginx:
```bash
/etc/nginx/nginx.conf
```

A tener en cuenta
```nginx
http{
#
include /path; # incluede se usa para modularizar y organizar la configuración importando el contenido de otros archivos
access_log /path; # registra todas las solicitudes de clientes
}
```

----
# Desplegar Web

En uno de los includes
```bash
http{
include /etc/nginx/webs;
}
```

Debemos poner nuestro fichero que contiene la configuración de la web
```bash
nano /etc/nginx/webs/default
```

```nginx
server{
	listen 80; # Escucha por el puerto 80
	#listen 80 default-server;
	listen [::]:80; # Escucha por el puerto 80 IPv6
	# listen [::]:80 default-server
	server_name antonio.com; # Dominio
	#server_name _; ## Para dejarlo en blanco_ 
	root /var/www/html/antonio; # Ruta al contenido
	location / {
		try_files $uri $uri/ =404;
		# Prueba una lista de archivos y si ninguno existe, devuelve 404
		# $uri = domain/file_buscado
		# $uri/ = Si no encuentra $uri lo trata como un directorio y busca el index
	}
	index index.html index.htm index.nginx-debian.html; # Poco que comentar 🙄
	location ~ /\.ht {
	    deny all;
    } # Deniega el acceso al cliente que intente buscar dominio/.ht*
	  # Por ejemplo https://domain.com/.htpasswd
}
```

```bash
mkdir -p /var/www/html/antonio
echo "<h1>Hola</h1>" >> /var/www/html/antonio/index.html
nginx -s reload
```

----
# OpenSSL

```bash
mkdir -p /etc/nginx/ssl
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/ssl/nginx-selfsigned.key -out /etc/nginx/ssl/nginx-selfsigned.crt -subj "/C=ES/ST=Madrid/L=Madrid/O=MiOrg/OU=IT/CN=antonio.com"
```
- openssl req: Comando para crear solicitudes de certificados
- x509: Crea un certificado autofirmado
- nodes: No DES - No encripta la clave privada (sin passphrase), sin esto, tendrías que ingresar una contraseña cada vez que se use la clave
- days 365: El certificado será válido por 365 días (1 año)
- newkey rsa:2048: Crea una nueva clave RSA de 2048 bits, 2048 bits es un tamaño seguro y estándar
- keyout /etc/nginx/ssl/nginx-selfsigned.key: Ruta donde se guardará la clave privada
- out /etc/nginx/ssl/nginx-selfsigned.crt: Ruta donde se guardará el certificado

```nginx
server {
	listen 443 ssl default_server; # Puerto de ssl
    listen [::]:443 ssl default_server;

    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt; # Ruta a la clave pub
    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key; # Ruta a la clave privada

    # Configuración SSL recomendada
    ssl_protocols TLSv1.2 TLSv1.3; # Veriosnes que acepta de ssl
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384; # algoritmos de cifrado permitidos
    ssl_prefer_server_ciphers off; # El cliente decide el cipher
    # cipher es un algoritmo matemático que se utiliza para encriptar y desencriptar datos
        
    root /var/www/html/antonio;
    index index.html index.htm index.nginx-debian.html;
    server_name antonio.com;

    location / {
	try_files $uri $uri/ =404;
    }
location ~ /\.ht {
                deny all;
        }
}
```

```bash
nginx -s reload
```

En el cliente
```bash
scp root@antonio.com:/etc/nginx/ssl/*.crt /usr/local/share/ca-certificates
# O si no hay ssh
openssl s_client -connect antonio.com:443 -showcerts </dev/null 2>/dev/null | openssl x509 -outform PEM > certificado.crt
mv certificado.crt /usr/local/share/ca-certificates
```

Una vez en la máquina cliente
```bash
sudo update-ca-certificates
```

---
# Proxy pass

```nginx
server{
	location /html {
		proxy_pass http://192.168.1.253:80/; # con / final no muestra /html en la url
		proxy_ssl_verify off; 
		# Si tenemos ssl configurado y queremos evitar que lo use el backend
	}
}
```

Si queremos que el backend tenga ssl debemos generar la clave como emos hecho anteriormente, pero, si solo se va a acceder mediante el proxy no hace falta que lo descargue ningún cliente, solo hay que cambiar el fichero del nginx proxy
```nginx
server {
#
	location /html {
		proxy_pass https:192.168.1.253:443/;
	}
}
```

---
# Load Balancer (Balanceador de carga)

Un upstream define un grupo de servidores backend a los que nginx redirigira el tráfico

```nginx
http {
#
	upstream backend {
		server 192.168.1.253:443 weight=5;
		server 192.168.1.252:443;
		server 192.168.1.251:443 backup;
	}
}
```

```nginx
server{
#
	location /html {
		proxy_pass https://backend/;
	}
}
```

También podemos hacer un balanceador de carga con tcp y udp, el fichero nginx.conf
```nginx
stream{
	include /path;
	upstream wire {
		server 192.168.1.253:51820;
		server 192.168.1.252:51820 weight=2;
	}
}
```

```nginx
server {
#
	listen 53; # Puerto que escucha
	proxy_pass wire;
}
```

---
# Proxy avanzado

```nginx
server{
#
	location /html {
		proxy_pass https://backend/;
		proxy_set_header Host $host; # Envia el header con el valor original
		proxy_set_header X-Real-IP $remote_addr; # Envia la IP real del cliente
		proxy_buffers 16 4k;
		# 16 buffers disponibles de 4Kb
		proxy_buffer_size 2k;
		# Define el tamaño de búfer de la primera parte
		# nginx lee los 2Kb si es mas grande usa 16 4k
		
		# proxy_buffering off;
		proxy_bind 127.0.0.1; # IP saliente hacia el backend
	}
}
```

---
# Compresión

Se usa para reducir el tamaño de los archivos que se envían desde el servidor al cliente

```nginx
http {
	gzip on; # Activamos
	gzip_comp_level 6; # Nivel de compresión
	gzip_proxied any; # Comprimir también para proxies
	# gzip_proxied    no-cache no-store private expired auth;
	## Comprimir por valores
	gzip_disable "msie6"; # Desabilitar para navegadores antiguos
	gzip_min_length 256; # Mínimo tamaño para comprimir en bytes
	gzip_types text/plain application/xml; # Tipo MIME a comprimir
	gzip_static on; # Busca precomprimidos antes de hacerlo el
}
```