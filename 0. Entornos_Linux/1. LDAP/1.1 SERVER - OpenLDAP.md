# 1. Instalación
Configuramos IP estática
```bash
# (Netplan)
nano /etc/netplan/01-netcfg.yaml
```

```yaml
network:
	version: 2
	etherntes:
		enp0s3:
			addresses:
				- 192.168.1.254/24
			routes:
				- to: default
				  via: 192.168.1.1
			nameservers:
				addresses: [8.8.8.8,1.1.1.1]	
```

Nombre del servidor
```bash
echo "ldap-server" > /etc/hostname
echo -e "127.0.0.1 ldap-server.local.com ldap-server\n192.168.1.254 ldap-server.local.com ldap-server" >> /etc/hosts 
```

Instalación
```bash
apt update && apt install slapd ldap-utils openssl ca-certificates -y
```
![[Pasted image 20250912012919.png]]
![[Pasted image 20250912012939.png]]


Configuramos slapd
```bash
dpkg-reconfigure slapd
```

![[Pasted image 20250912012847.png]]
![[Pasted image 20250911232749.png]]
![[Pasted image 20250911232824.png]]
![[Pasted image 20250912012917.png]]
![[Pasted image 20250912012939.png]]
![[Pasted image 20250912012957.png]]![[Pasted image 20250912012551.png]]

Para ver la base de datos de LDAP
```bash
slapcat
```

---
# Generación de certificados

```bash
mkdir -p /etc/ldap/certs /etc/ldap/private
chmod 750 /etc/ldap/private
# Genera una clave sin contraseña y válido durante 10 años
openssl req -newkey rsa:3072 -nodes -keyout /etc/ldap/private/ldap-server.local.com.key \
  -x509 -days 3650 -sha256 -out /etc/ldap/certs/ldap-server.local.com.crt \
  -subj "/C=ES/ST=Madrid/L=Madrid/O=MiOrg/OU=IT/CN=ldap-server.local.com"
```

- openssl req: genera solicitudes de certificados
- newkey rsa:3072: clave privada tipo RSA 3072 bits
- nodes: no contraseña
- keyout: donde se guarda la clave privada
- x509: crea certificado autogenerado
- sha256: algoritmo
- out: donde se guarda la clave pública

Fichero de cambios

```bash
nano tls.ldif
```

```txt
dn: cn=config
changetype: modify
replace: olcTLSCACertificateFile
olcTLSCACertificateFile: /etc/ldap/certs/ldap-server.local.com.crt
-
replace: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ldap/certs/ldap-server.local.com.crt
-
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ldap/private/ldap-server.local.com.key
```

```bash
# Permisos correctos
sudo chmod 644 /etc/ssl/certs/ldap-server.crt
sudo chmod 600 /etc/ssl/private/ldap-server.key
sudo chown root:root /etc/ssl/private/ldap-server.key
# Aplicamos cambios
ldapmodify -Y EXTERNAL -H ldapi:/// -f /tmp/tls.ldif
systemctl restart slapd
```

---
# Agregar unidad organizativa

```bash
nano ou.ldif
```

```txt
dn: ou=web,dc=ldap-server,dc=local,dc=com
objectClass: top
objectClass: organizationalUnit
ou: web
```

- dn = identificación única completa del objeto
	ou = unidad organizativa
	dc = Domain component
- objectClass = Tipo de objeto
	top = clase padre
	organizationalUnit = Unidad organizatica
- ou = nombre de la organización

### Aplicamos los cambios

```bash
ldapadd -x -D cn=admin,dc=ldap-server,dc=local,dc=com -W -f ou.ldif
```
- x: Autenticación simple
- D: datos de autenticación
- W: Pide contraseña
- f: especificar fichero

Si necesitamos borrar la unidad organizativa:
```bash
ldapdelete -x -D cn=admin,dc=ldap-server,dc=local,dc=com -W "ou=web,dc=ldap-server,dc=local,dc=com"
```

Cuando agreguemos 

---

# Agregamos grupo

```bash
nano grp.ldif
```

```txt
dn: cn=web-group,ou=web,dc=ldap-server,dc=local,dc=com
objectClass: top
objectClass: posixGroup
gidNumber: 10000
cn: grupo
```

posixGroup = Grupo posix (Linux/UNIX)

```bash
ldapadd -x -D cn=admin,dc=ldap-server,dc=local,dc=com -W -f grp.ldif
```

Si necesitamos borrar
```bash
ldapdelete -x -D cn=admin,dc=ldap-server,dc=local,dc=com -W "cn=web-group,ou=web,dc=ldap-server,dc=local,dc=com"
```

---

# Agregamos usuario

Generamos una contraseña
```bash
slappasswd
```
![[Pasted image 20250912002304.png]]
La linea marcada en blanco debemos guardarla, es la contraseña encriptada

```bash
nano usr.ldif
```

```txt
dn: uid=jlopez,ou=web,dc=ldap-server,dc=local,dc=com
objectClass: top
objectClass: posixAccount
objectClass: inetOrgPerson
objectClass: person
cn: jlopez
uid: jlopez
ou: web-group
uidNumber: 2000
gidNumber: 10000
homeDirectory: /home/jlopez
loginShell: /bin/bash
userPassword: {SSHA}uAwcVoYP3uURidaFu9H8XoSp65RWv5yd
sn: Lopez
mail: juan.lopez@somebooks.com
givenName: jlopez
```

- objectClass = inetOrgPerson
	Para personas en organizaciones de Internet, permite atributos como mail, givenName, sn

- objectClass: person
	Clase estructural para personas, requiere cn (common name) y sn (surname)


Vemos los nuevos cambios
```bash
slapcat
```
![[Pasted image 20250912003634.png]]

---

# Buscar y modificar

#### Para buscar
```bash
ldapsearch -xLLL -b "dc=ldap-server,dc=local,dc=com" uid=* sn givenName mail
```

- **x**  indica que usaremos autentificación simple.
- **LLL** sirve para que la salida sea del tipo LDAPv1.
- **b** va seguida del punto del árbol donde debe comenzar la búsqueda. En este caso, dc=somebooks,dc=local.

Ejemplos:
```bash
ldapsearch -xLLL -b "dc=ldap-server,dc=local,dc=com" uid=*
ldapsearch -xLLL -b "dc=ldap-server,dc=local,dc=com" uidNumber=2000
ldapsearch -xLLL -b "dc=ldap-server,dc=local,dc=com" gidNumber=10000
```

#### Para cambios

```bash
nano changes.ldif
```

```txt
dn: uid=jlopez,ou=web,dc=ldap-server,dc=local,dc=com
changetype: modify
replace: mail
mail: jlopez2.gomez@somebooks.local
```

```bash
ldapmodify -x -D cn=admin,dc=ldap-server,dc=local,dc=com -W -f changes.ldif
```

```bash
# Verificar cambios
ldapsearch -xLLL -b "dc=ldap-server,dc=local,dc=com" uid=jlopez
```